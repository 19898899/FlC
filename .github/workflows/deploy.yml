name: Deploy Configs to GitHub Pages

on:
  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆæµ‹è¯•é˜¶æ®µæ¨èï¼‰
  schedule:
    - cron: "*/15 * * * *"  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒåˆ†æ”¯é€‰æ‹©ï¼‰
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - master
          - develop
      force_refresh:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆ'
        required: false
        default: false
        type: boolean
  
  # æ·»åŠ pushè§¦å‘ï¼Œå½“ç›¸å…³æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨æ‰§è¡Œ
  push:
    branches: [ main, master ]
    paths:
      - 'tututututut53.py'
      - 'requirements.txt'
      - '.github/workflows/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å¦‚æœæ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„åˆ†æ”¯
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Show workflow info
        run: |
          echo "=== å·¥ä½œæµä¿¡æ¯ ==="
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘åˆ†æ”¯: ${{ github.ref }}"
          echo "è§¦å‘æ—¶é—´: $(date)"
          echo "æ‰‹åŠ¨è§¦å‘å‚æ•°:"
          echo "  åˆ†æ”¯: ${{ github.event.inputs.branch || 'æœªæŒ‡å®š' }}"
          echo "  å¼ºåˆ¶åˆ·æ–°: ${{ github.event.inputs.force_refresh || 'æœªæŒ‡å®š' }}"
          echo "å·¥ä½œæµID: ${{ github.run_id }}"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: '**/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then
            echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
            pip install -r requirements.txt
            echo "å·²å®‰è£…çš„åŒ…:"
            pip list
          else
            echo "âš ï¸ requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi

      - name: Create environment info file
        run: |
          echo "ç”Ÿæˆç¯å¢ƒä¿¡æ¯..."
          python -c "
import sys, os, platform, datetime, json, subprocess, pkg_resources

info = {
    'python': {
        'version': sys.version,
        'executable': sys.executable,
        'path': sys.path
    },
    'system': {
        'platform': platform.platform(),
        'machine': platform.machine(),
        'processor': platform.processor()
    },
    'time': {
        'utc': str(datetime.datetime.utcnow()),
        'local': str(datetime.datetime.now()),
        'timezone': str(datetime.datetime.now().astimezone().tzinfo)
    },
    'github': {
        'event': '${{ github.event_name }}',
        'ref': '${{ github.ref }}',
        'sha': '${{ github.sha }}',
        'run_id': '${{ github.run_id }}'
    }
}

# è·å–å·²å®‰è£…åŒ…
try:
    installed_packages = [str(pkg) for pkg in pkg_resources.working_set]
    info['packages'] = installed_packages[:20]  # åªæ˜¾ç¤ºå‰20ä¸ª
except:
    info['packages'] = 'æ— æ³•è·å–åŒ…ä¿¡æ¯'

print(json.dumps(info, indent=2, ensure_ascii=False))
          " > environment_info.json
          
          echo "ç¯å¢ƒä¿¡æ¯å·²ä¿å­˜åˆ° environment_info.json"

      - name: Run script to generate configs
        env:
          TZ: "UTC"
          PYTHONUNBUFFERED: "1"
          FORCE_REFRESH: ${{ github.event.inputs.force_refresh || 'false' }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œé…ç½®ç”Ÿæˆè„šæœ¬..."
          echo "ç¯å¢ƒå˜é‡:"
          echo "  TZ=$TZ"
          echo "  FORCE_REFRESH=$FORCE_REFRESH"
          
          # è®°å½•è„šæœ¬å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # æ‰§è¡Œä½ çš„è„šæœ¬
          python tututututut53.py
          
          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "â±ï¸  æ‰§è¡Œè€—æ—¶: ${DURATION}ç§’"

      - name: Verify generated files
        run: |
          echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
          if [ -d "./docs" ]; then
            echo "âœ… docsç›®å½•å­˜åœ¨"
            echo "ğŸ“ ç›®å½•ç»“æ„:"
            find ./docs -type f -name "*.json" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" | head -30
            
            echo ""
            echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
            echo "æ€»æ–‡ä»¶æ•°: $(find ./docs -type f | wc -l)"
            echo "JSONæ–‡ä»¶æ•°: $(find ./docs -type f -name "*.json" | wc -l)"
            echo "ç›®å½•å¤§å°: $(du -sh ./docs | cut -f1)"
            
            echo ""
            echo "ğŸ“… æœ€æ–°ä¿®æ”¹çš„5ä¸ªæ–‡ä»¶:"
            find ./docs -type f -exec ls -la {} \; | sort -k6,7 -r | head -5
            
            # æ˜¾ç¤ºä¸€äº›ç¤ºä¾‹æ–‡ä»¶å†…å®¹ï¼ˆå‰å‡ è¡Œï¼‰
            echo ""
            echo "ğŸ“„ ç¤ºä¾‹æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            SAMPLE_FILE=$(find ./docs -type f -name "*.json" | head -1)
            if [ -n "$SAMPLE_FILE" ]; then
              echo "æ–‡ä»¶: $SAMPLE_FILE"
              head -5 "$SAMPLE_FILE"
            fi
          else
            echo "âŒ é”™è¯¯: docsç›®å½•ä¸å­˜åœ¨!"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

      - name: Prepare for deployment
        run: |
          echo "å‡†å¤‡éƒ¨ç½²..."
          # åˆ›å»ºREADMEæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          cat > ./docs/README.md << EOF
          # è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          
          è¿™äº›é…ç½®æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          
          - æœ€åæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}
          - å·¥ä½œæµID: ${{ github.run_id }}
          - ä»“åº“: ${{ github.repository }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          
          ç”Ÿæˆè„šæœ¬: tututututut53.py
          EOF
          
          # å¤åˆ¶ç¯å¢ƒä¿¡æ¯åˆ°docsç›®å½•
          if [ -f environment_info.json ]; then
            cp environment_info.json ./docs/environment_info.json
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: |
            Update configs
            - Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            - Workflow: ${{ github.workflow }} #${{ github.run_id }}
            - Trigger: ${{ github.event_name }}
            - Branch: ${{ github.ref_name }}
          force_orphan: false
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          allow_empty_commit: true
          # æ·»åŠ æ ‡ç­¾ï¼Œä¾¿äºè¯†åˆ«
          tag_name: "v$(date +%Y%m%d-%H%M%S)"
          tag_message: "Auto-deploy from workflow"

      - name: Summary
        run: |
          echo "========================================"
          echo "âœ… éƒ¨ç½²å®Œæˆ!"
          echo "========================================"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date -u)"
          echo "ğŸ”— è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“Š ç”Ÿæˆæ–‡ä»¶æ•°: $(find ./docs -type f 2>/dev/null | wc -l || echo 'æœªçŸ¥')"
          echo "ğŸ“ GitHub Pagesåˆ†æ”¯: gh-pages"
          echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ·ï¸  æœ¬æ¬¡æäº¤æ ‡ç­¾: v$(date +%Y%m%d-%H%M%S)"
          echo ""
          echo "ğŸ” åç»­æ“ä½œ:"
          echo "1. è®¿é—®ä¸Šé¢çš„URLæŸ¥çœ‹éƒ¨ç½²ç»“æœ"
          echo "2. æŸ¥çœ‹Actionsæ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "3. æŸ¥çœ‹gh-pagesåˆ†æ”¯: https://github.com/${{ github.repository }}/tree/gh-pages"
          echo "========================================"

      - name: Create deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
            exit 1
          
